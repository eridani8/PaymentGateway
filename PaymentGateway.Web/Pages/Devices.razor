@page "/devices"
@attribute [Authorize(Roles = "User,Admin,Support")]
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILogger<Devices> Logger
@inject AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService
@inject IDeviceService DeviceService
@* @implements IAsyncDisposable *@
@* @implements IDisposable //TODO *@

<AuthorizeView Roles="User,Admin,Support">
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
            <MudPaper Class="pa-4" Elevation="12" Style="height: 100%; display: flex; flex-direction: column;">
                <MudToolBar>
                    <MudText Typo="Typo.h6">Список устройств</MudText>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.QrCode"
                              OnClick="@OpenDeviceQrDialog">
                        Авторизация устройства
                    </MudButton>
                </MudToolBar>
            </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/");
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task OpenDeviceQrDialog()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated != true)
        {
            Snackbar.Add("Необходима авторизация", Severity.Error);
            return;
        }

        try
        {
            var response = await DeviceService.GenerateDeviceToken();

            if (response is null)
            {
                Snackbar.Add("Не удалось сгенерировать токен устройства", Severity.Error);
                return;
            }

            var parameters = new DialogParameters
            {
                { "QrCodeImage", $"data:image/png;base64,{response.QrCodeUri}" },
                { "Token", response.Token }
            };

            await DialogService.ShowAsync<DeviceQrDialog>(null, parameters);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка при генерации токена устройства");
            Snackbar.Add("Произошла ошибка при генерации токена устройства", Severity.Error);
        }
    }
}