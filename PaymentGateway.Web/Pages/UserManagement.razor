@page "/UserManagement"
@using PaymentGateway.Shared.DTOs.User
@attribute [Authorize(Roles = "Admin")]
@inject IAdminService AdminService
@inject IDialogService DialogService
@inject ILogger<UserManagement> Logger
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject SignalRService SignalRService
@implements IAsyncDisposable

<AuthorizeView Roles="Admin">
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
            <MudPaper Class="pa-4" Elevation="12" Style="height: 100%; display: flex; flex-direction: column;">
                <MudToolBar>
                    <MudText Typo="Typo.h6">Список пользователей</MudText>
                    <MudSpacer />
                    <MudButton 
                        Variant="Variant.Filled" 
                        Color="Color.Primary" 
                        StartIcon="@Icons.Material.Filled.Add" 
                        OnClick="OpenCreateDialog">
                        Создать пользователя
                    </MudButton>
                </MudToolBar>
                <MudDataGrid T="UserDto" 
                            Items="@_users" 
                            Loading="@_isLoading" 
                            SortMode="SortMode.Multiple" 
                            Filterable="true"
                            Hideable="true"
                            Bordered="true">
                    <Columns>
                        <PropertyColumn Property="x => x.Id" Title="ID"/>
                        <PropertyColumn Property="x => x.Username" Title="Логин"/>
                        <TemplateColumn Title="Роли">
                            <CellTemplate Context="cellContext">
                                @string.Join(", ", cellContext.Item.Roles)
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Статус">
                            <CellTemplate Context="cellContext">
                                <MudChip Color="@(cellContext.Item.IsActive ? Color.Success : Color.Error)" Size="Size.Small">
                                    @(cellContext.Item.IsActive ? "Активен" : "Неактивен")
                                </MudChip>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Действия">
                            <CellTemplate Context="cellContext">
                                @if (cellContext.Item.Username != "root")
                                {
                                    <MudIconButton 
                                        Icon="@Icons.Material.Filled.Edit" 
                                        Color="Color.Primary" 
                                        Size="Size.Small"
                                        OnClick="@(() => OpenEditDialog(cellContext.Item))" 
                                        Title="Редактировать"/>
                                    <MudIconButton 
                                        Icon="@Icons.Material.Filled.Delete" 
                                        Color="Color.Error" 
                                        Size="Size.Small"
                                        OnClick="@(() => OpenDeleteDialog(cellContext.Item))" 
                                        aria-label="delete"/>
                                }
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/");
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool _isLoading = true;
    private List<UserDto> _users = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await SignalRService.InitializeAsync();
        SignalRService.SubscribeToUserUpdates(HandleUserUpdate);
        SignalRService.SubscribeToUserDeletions(HandleUserDeleted);
    }

    private void HandleUserUpdate(UserDto updatedUser)
    {
        try
        {
            var existingUser = _users.FirstOrDefault(u => u.Id == updatedUser.Id);
            if (existingUser != null)
            {
                var index = _users.IndexOf(existingUser);
                _users[index] = updatedUser;
            }
            else
            {
                _users.Add(updatedUser);
            }
            StateHasChanged();
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Ошибка при обновлении пользователя {UserId}", updatedUser?.Id);
        }
    }

    private void HandleUserDeleted(Guid userId)
    {
        try
        {
            var user = _users.FirstOrDefault(u => u.Id == userId);
            if (user != null)
            {
                _users.Remove(user);
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Ошибка при удалении пользователя {UserId}", userId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        SignalRService.UnsubscribeFromUserUpdates();
        SignalRService.UnsubscribeFromUserDeletions();
        await SignalRService.DisposeAsync();
    }

    private async Task LoadUsers()
    {
        try
        {
            _isLoading = true;
            _users = await AdminService.GetUsers();
        }
        catch (Exception e)
        {
            Logger.LogError(e, e.Message);
            Snackbar.Add("Ошибка при загрузке пользователей", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateUserDialog>(null);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add("Пользователь успешно создан", Severity.Success);
        }
    }
    
    private async Task OpenDeleteDialog(UserDto user)
    {
        var parameters = new DialogParameters { ["User"] = user };
        var dialog = await DialogService.ShowAsync<DeleteUserDialog>(null, parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add("Пользователь успешно удален", Severity.Success);
        }
    }

    private async Task OpenEditDialog(UserDto user)
    {
        var parameters = new DialogParameters
        {
            ["User"] = user
        };

        var dialog = await DialogService.ShowAsync<EditUserDialog>(null, parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var updateDto = (UpdateUserDto)result.Data!;
            try
            {
                await AdminService.UpdateUser(updateDto);
                Snackbar.Add("Пользователь успешно обновлен", Severity.Success);
            }
            catch (Exception e)
            {
                Logger.LogError(e, e.Message);
                Snackbar.Add("Ошибка при обновлении пользователя", Severity.Error);
            }
        }
    }
}